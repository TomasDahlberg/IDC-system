#include <stdio.h>
#include <stdlib.h>
#include <string.h>

long filesize(FILE *stream)
{
   long curpos, length;

   curpos = ftell(stream);
   fseek(stream, 0L, SEEK_END);
   length = ftell(stream);
   fseek(stream, curpos, SEEK_SET);
   return length;
}

void main(argc, argv)
int argc;
char *argv[];
{
  FILE *fpIn, *fpOut;
  int i, n;
  long int lb, siz, neededSpace;
  char buf[16384];
  char str[256];

  if (argc != 4) {
	printf("Usage: copyr file1 file2 <output-file>\n");
	printf("       copies file1+space+file2 to output-file\n");
	printf("       space is enough to fill up 512k\n");
	exit(1);
  }

  if ((fpIn = fopen(argv[1], "rb")) == 0) {
	printf("cannot open '%s'\n", argv[1]);
	exit(1);
  }
  if ((fpOut = fopen(argv[3], "wb")) == 0) {
	printf("cannot create '%s'\n", argv[2]);
	exit(1);
  }
/*
!	Copy the first file...
*/
  lb = 0;
  printf("Copying file '%s'...", argv[1]); fflush(stdout);
  while (n = fread(buf, 1, 16384, fpIn)) {
    if (n != fwrite(buf, 1, n, fpOut)) {
	printf("Error writing file, errno = %d\n", errno);
    }
    lb += n;
  }
  fclose(fpIn);
  printf("%ld bytes\n", lb);
/*
!	and open second file to calculate file size...
*/
  if ((fpIn = fopen(argv[2], "rb")) == 0) {
	printf("cannot open '%s'\n", argv[2]);
	exit(1);
  }
  siz = filesize(fpIn);
/*
!	and append space...
*/
  neededSpace = 524288L - siz - lb;
  printf("Second file is %d bytes in size\n", siz);
  printf("Needed space is %ld bytes\n", neededSpace);
  printf("since first file occupied %ld bytes\n", lb);
  printf("and total storage is %ld bytes.\n", 524288L);
  if (neededSpace < 0) {
    printf("Error two files larger than 512k!\n");
    exit(1);
  }
  for (n = 0; n < 512; n++)
    buf[n] = 255;

  while (neededSpace) {
    if (neededSpace > 512)
      n = 512;
    else
      n = neededSpace;
    if (n != fwrite(buf, 1, n, fpOut)) {
	printf("Error writing space to file, errno = %d\n", errno);
    }
    neededSpace -= n;
    lb += n;
  }
  printf("After space has been appended file size is %ld bytes\n", lb);
/*
! 	and copy the second file.
*/
  printf("Copying file '%s'...", argv[2]); fflush(stdout);
  while (n = fread(buf, 1, 512, fpIn)) {
    if (n != fwrite(buf, 1, n, fpOut)) {
	printf("Error writing file, errno = %d\n", errno);
    }
    lb += n;
  }
  fclose(fpIn);
  fclose(fpOut);
  printf("%ld bytes\n", lb);
}

